<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_angular_provider">
    <sp_angular_provider action="INSERT_OR_UPDATE">
        <name>scmRefPicker</name>
        <script><![CDATA[/**
 * scmReference Directive
 * This directive provides a reference input field that allows users to search and
 * select records from a specified table.
 * It supports searching by multiple fields, displaying results, and handling
 * selections.
 */
function scmRefPicker($http, spUtil, $timeout) {
  "use_strict";
  return {
    restrict: "E",
    replace: true,
    require: "ngModel",
    scope: {
      table: "@",
      searchFields: "@",
      placeholder: "@?",
      label: "@",
      referenceQualifier: "@?",
      pageSize: "@?",
      minimumInputLength: "@?",
      delay: "@?",
      displayFields: "@?",
      initialDisplayValue: "@?",
    },

    /**
     * The tag li uses the event ng-mousedown to select the item.
     * Usually, the event ng-click is used, but in this case,
     * it does not work because
     * the event ng-blur of the input is triggered before the ng-click of the li.
     */
    template: `
            <div class="scm-reference-wrapper">
                <label
                  ng-if="label"
                  for="{{uid}}">
                  {{ label }}
                </label>
                <div class="scm-reference-input-wrapper">
                    <a
                      ng-if="ngModelCtrl.$viewValue"
                      ng-click="clearSelection()"
                      class="scm-reference-clear-icon">
                        <sdx-icon icon-name="icon-close" size="1"></sdx-icon>
                    </a>
                    <input
                      id="{{uid}}"
                      type="text"
                      ng-model="searchTerm"
                      ng-focus="openList()"
                      ng-blur="closeList()"
                      ng-change="onSearch()"
                      placeholder="{{ placeholder || 'Search...' }}"
                      class="input scm-reference-input"
                      ng-class="{ 'scm-reference-value': ngModelCtrl.$viewValue, 'scm-reference-list-open': showResults }"
                    />
                    <sdx-icon 
                      class="scm-reference-magnifying-glass-icon" 
                      icon-name="icon-search" size="3">
                    </sdx-icon>
                </div>
                <ul
                  class="scm-autocomplete-list"
                  ng-show="showResults">
                    <li 
                      class="scm-autocomplete-item"
                      ng-repeat="item in results track by item.display"
                      ng-mousedown="selectItem(item)"
                      ng-mouseenter="hoverIndex = $index"
                      ng-class="{ 'scm-item-hover': hoverIndex === $index }">
                        {{ item.display }}
                    </li>
                    <li
                      class="scm-autocomplete-item scm-autocomplete-load-more"
                      ng-if="moreResults"
                      ng-mousedown="loadMore()">
                      Load more results…
                    </li>
                    <li
                      class="scm-autocomplete-item scm-autocomplete-no-results"
                      ng-if="results.length == 0">
                      No results…
                    </li>
                    <li
                      class="scm-autocomplete-item scm-autocomplete-no-more"
                      ng-if="!moreResults && results.length">
                      No more results…
                    </li>
                </ul>
            </div>
        `,
    link: (scope, element, attrs, ngModelCtrl) => {
      // We have to expose the ngModelCtrl to the scope so that we can use it
      // in the template.
      scope.ngModelCtrl = ngModelCtrl;

      // Unique ID for label-for and input
      scope.uid = attrs.id || spUtil.createUid("xxxx-xxxx");

      // Used to calculata the "start" parameter sent to the http service
      scope.page = 0;

      // Flag used to determine if there are more results to load
      scope.moreResults = false;

      const input = element.find("input")[0];

      // Model binding - if we receive a sys_id, keep it but don't show it
      ngModelCtrl.$render = (displayValue) => {
        // Only update searchTerm if it's actually a display value, not a sys_id
        if (
          displayValue &&
          displayValue.length === 32 &&
          displayValue.match(/^[a-f0-9]+$/i)
        ) {
          // This looks like a sys_id, don't show it in the input
          scope.searchTerm = "";
        } else {
          scope.searchTerm = displayValue;
        }
      };

      // Configuration values
      const pageSize = scope.pageSize
        ? parseInt(scope.pageSize, 10)
        : NOW.ac_max_search_matches;
      const minCharts = scope.minimumInputLength
        ? parseInt(scope.minimumInputLength, 10)
        : 2;
      const delay = scope.delay ? parseInt(scope.delay, 10) : NOW.ac_wait_time;

      // Internal state
      scope.searchTerm = null;
      scope.results = [];
      scope.showResults = false;
      scope.hoverIndex = -1;
      let timer;

      /**
       * Loads more results when the user clicks on "Load more results…".
       * It increments the page number and fetches the next set of results.
       * This function is called when the user clicks on the "Load more results…" item in
       * the list.
       */
      scope.loadMore = () => {
        scope.page++;
        fetchPage();
      };

      /**
       * Handles the search input change.
       * It checks if the search term is valid and triggers a search after a delay.
       * If the search term is empty or shorter than the minimum length, it hides the
       * results.
       * If the user is typing something different from the current display value,
       * it clears the model value to indicate a new search.
       */
      scope.onSearch = () => {
        if (timer) $timeout.cancel(timer);

        scope.results = [];

        if (!scope.searchTerm || scope.searchTerm.length < minCharts) {
          scope.showResults = false;
          return;
        }

        timer = $timeout(() => {
          scope.page = 0;
          fetchPage();
        }, delay);
      };

      /**
       * Opens the list of results.
       * It clears the input placeholder and resets the results.
       * This function is called when the input field is focused.
       * It prepares for search but keeps the current display value visible.
       */
      scope.openList = () => {
        input.setAttribute("placeholder", "");
        scope.results = [];
        ngModelCtrl.$setViewValue("");
        ngModelCtrl.$render("");
      };

      /**
       * Closes the list of results.
       * It hides the results and resets the hover index.
       * This function is called when the input field loses focus.
       * If there's a selected value, it restores the display value.
       * If the input is empty, it resets the placeholder to the default value.
       */
      scope.closeList = () => {
        // If the input is empty, reset placeholder
        if (!scope.searchTerm) {
          input.setAttribute("placeholder", scope.placeholder || "Search...");
        }
        scope.showResults = false;
        scope.hoverIndex = -1;
      };

      /**
       * Selects an item from the results.
       * It sets the view value to the selected item's sys_id and updates the display.
       * It also hides the results and resets the hover index.
       * This function is called when the user clicks on an item in the results list.
       * @param {Object} item - The selected item from the results list.
       */
      scope.selectItem = (item) => {
        ngModelCtrl.$setViewValue(item.sysId);
        ngModelCtrl.$render(item.display);
        scope.showResults = false;
        scope.hoverIndex = -1;
      };

      /**
       * Clears the current selection.
       * It sets the view value to an empty string, clears the display, and hides the
       * results.
       * It also resets the input placeholder to the default value.
       * This function is called when the user clicks on the clear icon.
       */
      scope.clearSelection = () => {
        ngModelCtrl.$setViewValue("");
        ngModelCtrl.$render(undefined);
        scope.showResults = false;
        input.setAttribute("placeholder", scope.placeholder || "Search...");
      };

      /**
       * Constructs the query string based on the search term and fields.
       * It formats the search fields using CONTAINS and applies the reference qualifier if provided.
       * @param {String} term
       * @returns {String} the formatted query string
       */
      function buildQuery(term) {
        let searchConditions = [];

        if (scope.searchFields) {
          // Split searchFields by semicolon and create CONTAINS conditions
          const fields = scope.searchFields.split(";").map((f) => f.trim());
          searchConditions = fields.map((field) => `${field}CONTAINS${term}`);
        } else {
          // Fallback to searching in common fields if no searchFields specified
          searchConditions = [`nameCONTAINS${term}`, `numberCONTAINS${term}`];
        }

        let finalQuery = searchConditions.join("^OR");

        // Add reference qualifier if provided
        if (scope.referenceQualifier) {
          finalQuery = `${scope.referenceQualifier}^${finalQuery}`;
        }

        return finalQuery;
      }

      /**
       * Fetches a page of results from the server using ServiceNow REST API.
       * It sends a GET request to the standard REST API endpoint with proper query parameters.
       * The results are then processed and displayed in the directive.
       * This function is called when the user types in the input field or clicks on
       * "Load more results…".
       */
      function fetchPage() {
        if (!scope.table) {
          console.warn("scmRefPicker: table parameter is required");
          return;
        }

        // Build the ServiceNow REST API URL for the specified table
        let apiUrl = "/api/now/table/" + scope.table;

        // Build query parameters array
        let params = [];

        // Add search query
        if (scope.searchTerm) {
          params.push(
            "sysparm_query=" + encodeURIComponent(buildQuery(scope.searchTerm))
          );
        }

        // Include both value and display_value in response
        params.push("sysparm_display_value=all");

        // Build fields parameter - always include sys_id, plus displayFields if specified
        let fields = ["sys_id"];
        if (scope.displayFields) {
          fields = fields.concat(
            scope.displayFields.split(",").map((f) => f.trim())
          );
        } else if (scope.searchFields) {
          // Include search fields in response
          fields = fields.concat(
            scope.searchFields.split(";").map((f) => f.trim())
          );
        }
        params.push("sysparm_fields=" + encodeURIComponent(fields.join(",")));

        // Pagination parameters
        params.push("sysparm_limit=" + pageSize);
        params.push("sysparm_offset=" + scope.page * pageSize);

        // Append parameters to URL
        if (params.length > 0) {
          apiUrl += "?" + params.join("&");
        }

        console.log("scmRefPicker: API URL:", apiUrl);

        // Make HTTP GET request to ServiceNow REST API
        $http
          .get(apiUrl)
          .then((response) => {
            console.log("scmRefPicker: response", response);

            if (response.data && response.data.result) {
              const items = response.data.result;

              const newResults = items.map((record) => {
                let display = "";

                if (scope.displayFields) {
                  // Handle multiple display fields - concatenate with comma
                  let displayFields = scope.displayFields
                    .split(",")
                    .map((field) => field.trim());
                  let displayValues = [];

                  displayFields.forEach(function (field) {
                    if (record[field] && record[field].display_value) {
                      displayValues.push(record[field].display_value);
                    }
                  });

                  display = displayValues.join(", ");
                } else {
                  // Fallback to using search fields for display
                  if (scope.searchFields) {
                    let searchFields = scope.searchFields
                      .split(";")
                      .map((field) => field.trim());
                    let displayValues = [];

                    searchFields.forEach(function (field) {
                      if (record[field] && record[field].display_value) {
                        displayValues.push(record[field].display_value);
                      }
                    });

                    display = displayValues.join(", ");
                  } else {
                    // Final fallback to sys_id
                    display = record.sys_id.value;
                  }
                }

                return {
                  sysId: record.sys_id.value, // Use sys_id as the value
                  display: display || record.sys_id.value, // Use constructed display or fallback to sys_id
                };
              });

              scope.results = scope.results.concat(newResults);
              scope.moreResults = items.length === pageSize;
              scope.showResults = true;
            }
          })
          .catch((error) => {
            console.error("scmRefPicker: Error loading results", error);
            scope.showResults = false;
          });
      }
    },
  };
}
]]></script>
        <sys_class_name>sp_angular_provider</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-08-28 20:10:38</sys_created_on>
        <sys_id>5f7b574b93a7a210e393f6fa3d03d678</sys_id>
        <sys_mod_count>4</sys_mod_count>
        <sys_name>scmRefPicker</sys_name>
        <sys_package display_value="SCM" source="x_680259_scm">9b70ffe7836a2650efda54b6feaad334</sys_package>
        <sys_policy/>
        <sys_scope display_value="SCM">9b70ffe7836a2650efda54b6feaad334</sys_scope>
        <sys_update_name>sp_angular_provider_5f7b574b93a7a210e393f6fa3d03d678</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-08-28 20:28:22</sys_updated_on>
        <type>directive</type>
    </sp_angular_provider>
</record_update>
